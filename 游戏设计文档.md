# 游戏需求分析

## 1. 核心战斗系统

### 1.1 移动与精准度

- **移动速度**：所有玩家、持有所有武器时，移动速度统一。
- **移动发散（核心机制）**：
  - **逻辑**：检测玩家输入。若位移矢量不为 0，则扩大准星偏移值（Spread）。
  - **实现**：服务端通过 `PhysicsCharacterController` 处理移动，并校验客户端上传的位置。
  - **状态**：静止（高精度）、跑动（低精度）。

### 1.2 武器伤害数值表 (基于 `config/weapons.json`)

| **武器名称**      | **ID** | **类型** | **价格** | **头/身伤害** | **射速** | **弹匣** | **备注**         |
| ----------------- | ------ | -------- | -------- | ------------- | -------- | -------- | ---------------- |
| **Glock-18**      | 1      | 副武器   | $200     | 80.0 / 20.0   | 6.0      | 20       | T 初始配备       |
| **USP-S**         | 2      | 副武器   | $300     | 100.0 / 25.0  | 5.5      | 12       | CT 初始配备      |
| **Desert Eagle**  | 3      | 副武器   | $1200    | 212.0 / 30.0  | 2.0      | 7        | 高伤害           |
| **AK-47**         | 4      | 主武器   | $2700    | 144.0 / 36.0  | 10.0     | 30       | T 专用           |
| **M4A1**          | 5      | 主武器   | $2900    | 132.0 / 34.0  | 11.0     | 30       | CT 专用          |

### 1.3 玩家属性 (PlayerState)

- **生命值 (HP)**：100 (Config::player::MAX_HEALTH)。
- **护甲**：目前代码中未显式实现护甲值逻辑，伤害直接扣除 HP。
- **武器槽位**：
  - 主武器 (Primary)
  - 副武器 (Secondary)
  - 近战/投掷物 (暂未实现)

------

## 2. 经济与回合逻辑

### 2.1 经济系统 (EconomySystem)

- **初始金钱**：$800。
- **金钱上限**：$8000 (需确认代码常量，暂定)。
- **购买逻辑**：
  - 仅在 `PrepareState` (准备阶段) 允许购买。
  - 校验余额是否充足。
  - 购买成功扣除金钱并更新武器槽位。
- **奖励机制**：
  - **击杀奖励**：+200 (待确认具体数值)。
  - **胜负奖励**：
    - 获胜方：+3000
    - 失败方：+2000
  - **任务奖励**：下包/拆包 +200。

### 2.2 游戏流程状态机 (MatchController)

游戏流程由 `MatchController` 驱动，状态流转如下：

1.  **WaitState**：等待玩家连接。
2.  **WarmupState**：热身阶段，玩家可自由移动射击，不计入战绩。
3.  **RoundState** (循环 6 局)：
    - **PreparePhase** (10s)：
        - 冻结移动 (`disableMove`)。
        - 允许购买 (`enablePurchase`)。
        - 禁止开火 (`disableFire`)。
    - **ActionPhase** (90s)：
        - 允许移动、开火。
        - 禁止购买。
        - T 尝试下包，CT 尝试击杀 T。
    - **BombPhase** (30s)：
        - 若 T 成功下包，进入此阶段。
        - 回合倒计时停止，C4 倒计时开始。
        - CT 尝试拆包。
    - **SettlePhase**：
        - 回合结束，计算胜负。
        - 发放金钱奖励。
        - 重置玩家位置和状态。
4.  **MatchEndState**：比赛结束，展示最终比分。

### 2.3 胜利条件

- **回合胜利**：
  - **T 胜**：全歼 CT 或 C4 爆炸。
  - **CT 胜**：全歼 T 或 拆除 C4 或 时间耗尽 T 未下包。
- **整场胜利**：
  - 先达到 4 胜的队伍获胜（或 6 局结束后比分高者）。
  - 若 3:3 则平局。

------

## 3. 核心交互机制

### 3.1 C4 爆破逻辑

- **下包 (Planting)**：
  - **条件**：T 阵营玩家在 `PlantSite` 区域内。
  - **状态**：`MatchController::c4_planted` 置为 true。
  - **倒计时**：进入 `BombPhase`。
- **拆除 (Defusing)**：
  - **条件**：CT 阵营玩家在 C4 附近。
  - **状态**：`MatchController::c4_defused` 置为 true。
  - **结果**：CT 直接获胜。

### 3.2 物理与同步

- **物理引擎**：JoltPhysics。
- **位置同步**：
  - 服务端维护 `PlayerUpdate` 历史队列 (`RingQueue<PlayerUpdate, 300>`)。
  - 客户端上传输入，服务端模拟并广播位置。
- **延迟补偿**：
  - 服务端记录过去一段时间的玩家位置 (`position_history`)。
  - 射击判定时，根据客户端上传的 `tick` 回溯目标玩家位置进行射线检测。

------

## 4. 界面与音效 (客户端)

### 4.1 HUD

- **顶部**：比分 (CT vs T)、剩余时间 / C4 图标。
- **左下**：HP、护甲（如有）。
- **右下**：当前武器、弹药、金钱。
- **中心**：准星 (Crosshair)。

### 4.2 音效

- **枪声**：不同武器独立音效。
- **环境音**：C4 滴答声（随倒计时频率加快）。


